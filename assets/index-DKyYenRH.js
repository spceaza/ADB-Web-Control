(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class S{#e;get promise(){return this.#e}#t;#r;#n="running";get state(){return this.#n}constructor(){this.#e=new Promise((e,t)=>{this.#t=e,this.#r=t})}resolve=e=>{this.#t(e),this.#n="resolved"};reject=e=>{this.#r(e),this.#n="rejected"}}class Vt{nextId;pendingResolvers=new Map;constructor(e=0){this.nextId=e}add(){const e=this.nextId++,t=new S;return this.pendingResolvers.set(e,t),[e,t.promise]}getResolver(e){if(!this.pendingResolvers.has(e))return null;const t=this.pendingResolvers.get(e);return this.pendingResolvers.delete(e),t}resolve(e,t){const n=this.getResolver(e);return n!==null?(n.resolve(t),!0):!1}reject(e,t){const n=this.getResolver(e);return n!==null?(n.reject(t),!0):!1}}function Ot(r){return new Promise(e=>{globalThis.setTimeout(()=>e(),r)})}function De(r){return typeof r=="object"&&r!==null&&"then"in r}function ve(r,e){for(;;){const{done:t,value:n}=r.next(e);if(t)return n;if(De(n))return n.then(s=>ve(r,{resolved:s}),s=>ve(r,{error:s}));e=n}}function Ne(r,e){function t(...n){const s=r.call(this,function*(i){if(De(i)){const a=yield i;if("resolved"in a)return a.resolved;throw a.error}return i},...n);return ve(s,void 0)}return t}function Kt(r){return(e,t)=>{if("buffer"in t){const n=r(e,t);return t.buffer.set(n,t.index),n.length}else return r(e,t)}}function Ft(r,e){return(t,n)=>{if("buffer"in n)return n.index??=0,e(t,n),r;{const s=new Uint8Array(r);return e(t,{buffer:s,index:0,littleEndian:n.littleEndian}),s}}}function Gt(r,e,t,n,s){const i={size:r,type:e,serialize:e==="default"?Kt(t):Ft(r,t),deserialize:Ne(n),omitInit:s?.omitInit};return s?.init&&(i.init=s.init),i}const L=Gt,x=new Uint8Array(0);function Ht(r,e){return typeof r=="number"?e?r===0?L(0,"byob",()=>{},function*(){return e.convert(x)}):L(r,"byob",(t,{buffer:n,index:s})=>{n.set(t.slice(0,r),s)},function*(t,n){const s=yield*t(n.readExactly(r));return e.convert(s)},{init(t){return e.back(t)}}):r===0?L(0,"byob",()=>{},function*(){return x}):L(r,"byob",(t,{buffer:n,index:s})=>{n.set(t.slice(0,r),s)},function*(t,n){return n.readExactly(r)}):(typeof r=="object"||typeof r=="function")&&"serialize"in r?e?L(r.size,"default",(t,{littleEndian:n})=>{if(r.type==="default"){const s=r.serialize(t.length,{littleEndian:n}),i=new Uint8Array(s.length+t.length);return i.set(s,0),i.set(t,s.length),i}else{const s=new Uint8Array(r.size+t.length);return r.serialize(t.length,{buffer:s,index:0,littleEndian:n}),s.set(t,r.size),s}},function*(t,n,s){const i=yield*t(r.deserialize(n,s)),a=yield*t(n.readExactly(i));return e.convert(a)},{init(t){return e.back(t)}}):L(r.size,"default",(t,{littleEndian:n})=>{if(r.type==="default"){const s=r.serialize(t.length,{littleEndian:n}),i=new Uint8Array(s.length+t.length);return i.set(s,0),i.set(t,s.length),i}else{const s=new Uint8Array(r.size+t.length);return r.serialize(t.length,{buffer:s,index:0,littleEndian:n}),s.set(t,r.size),s}},function*(t,n,s){const i=yield*t(r.deserialize(n,s));return yield*t(n.readExactly(i))}):typeof r=="string"?e?L(0,"default",t=>t,function*(t,n,{dependencies:s}){const i=s[r];return i===0?x:n.readExactly(i)},{init(t,n){const s=e.back(t);return n[r]=s.length,s}}):L(0,"default",t=>t,function*(t,n,{dependencies:s}){const i=s[r];return i===0?x:n.readExactly(i)},{init(t,n){n[r]=t.length}}):e?L(0,"default",t=>t,function*(t,n,{dependencies:s}){const i=s[r.field],a=r.convert(i);return a===0?x:n.readExactly(a)},{init(t,n){const s=e.back(t);return n[r.field]=r.back(s.length),s}}):L(0,"default",t=>t,function*(t,n,{dependencies:s}){const i=s[r.field],a=r.convert(i);return a===0?x:n.readExactly(a)},{init(t,n){n[r.field]=r.back(t.length)}})}const ne=Ht;class we extends Error{constructor(){super("ExactReadable ended")}}class Yt{#e;#t;get position(){return this.#t}constructor(e){this.#e=e,this.#t=0}readExactly(e){if(this.#t+e>this.#e.length)throw new we;const t=this.#e.subarray(this.#t,this.#t+e);return this.#t+=e,t}}class it extends Error{constructor(e){super(e)}}class Zt extends it{constructor(){super("The underlying readable was ended before the struct was fully deserialized")}}class Be extends it{constructor(){super("The underlying readable doesn't contain any more struct")}}function A(r,e){const t=Object.entries(r);let n=0,s=!0;for(const[,o]of t)n+=o.size,s&&o.type!=="byob"&&(s=!1);const i=e.littleEndian,a=e.extra?Object.getOwnPropertyDescriptors(e.extra):void 0;return{littleEndian:i,fields:r,extra:e.extra,type:s?"byob":"default",size:n,serialize(o,c){const l={...o};for(const[v,f]of t)if(v in l&&"init"in f){const _=f.init?.(l[v],l);_!==void 0&&(l[v]=_)}const u=new Array(t.length),p=new Array(t.length);{const v={littleEndian:i};for(const[f,[_,Se]]of t.entries())Se.type==="byob"?u[f]=Se.size:(p[f]=Se.serialize(l[_],v),u[f]=p[f].length)}const E=u.reduce((v,f)=>v+f,0);let z,D,U;if(c instanceof Uint8Array){if(c.length<E)throw new Error("Buffer too small");z=!0,D=c,U=0}else if(typeof c=="object"&&"buffer"in c){if(z=!0,D=c.buffer,U=c.index??0,D.length-U<E)throw new Error("Buffer too small")}else z=!1,D=new Uint8Array(E),U=0;const q={buffer:D,index:U,littleEndian:i};for(const[v,[f,_]]of t.entries())p[v]?D.set(p[v],q.index):_.serialize(l[f],q),q.index+=u[v];return z?E:D},deserialize:Ne(function*(o,c){const l=c.position,u={},p={dependencies:u,littleEndian:i};try{for(const[E,z]of t)u[E]=yield*o(z.deserialize(c,p))}catch(E){throw E instanceof we?c.position===l?new Be:new Zt:E}return a&&Object.defineProperties(u,a),e.postDeserialize?e.postDeserialize.call(u,u):u})}}function ze(r,e,t){return A(Object.assign({},r.fields,e),{littleEndian:t?.littleEndian??r.littleEndian,extra:r.extra,postDeserialize:t?.postDeserialize})}function Xt(r,e,t){return t?r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24:r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3]}function Qt(r,e,t,n){n?(r[e]=t,r[e+1]=t>>8,r[e+2]=t>>16,r[e+3]=t>>24):(r[e]=t>>24,r[e+1]=t>>16,r[e+2]=t>>8,r[e+3]=t)}function Jt(r,e,t){r[e]=Number(t&0xffn),r[e+1]=Number(t>>8n&0xffn),r[e+2]=Number(t>>16n&0xffn),r[e+3]=Number(t>>24n&0xffn),r[e+4]=Number(t>>32n&0xffn),r[e+5]=Number(t>>40n&0xffn),r[e+6]=Number(t>>48n&0xffn),r[e+7]=Number(t>>56n&0xffn)}function er(r,e,t){r[e]=Number(t>>56n&0xffn),r[e+1]=Number(t>>48n&0xffn),r[e+2]=Number(t>>40n&0xffn),r[e+3]=Number(t>>32n&0xffn),r[e+4]=Number(t>>24n&0xffn),r[e+5]=Number(t>>16n&0xffn),r[e+6]=Number(t>>8n&0xffn),r[e+7]=Number(t&0xffn)}function pe(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0}function tr(r,e,t){return t?(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0:(r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3])>>>0}function rr(r,e,t){r[e]=t,r[e+1]=t>>8,r[e+2]=t>>16,r[e+3]=t>>24}function nr(r,e,t,n){n?(r[e]=t,r[e+1]=t>>8,r[e+2]=t>>16,r[e+3]=t>>24):(r[e]=t>>24,r[e+1]=t>>16,r[e+2]=t>>8,r[e+3]=t)}function sr(r,e){return BigInt(r[e])<<56n|BigInt(r[e+1])<<48n|BigInt(r[e+2])<<40n|BigInt(r[e+3])<<32n|BigInt(r[e+4])<<24n|BigInt(r[e+5])<<16n|BigInt(r[e+6])<<8n|BigInt(r[e+7])}function ir(r,e,t){return t?BigInt(r[e])|BigInt(r[e+1])<<8n|BigInt(r[e+2])<<16n|BigInt(r[e+3])<<24n|BigInt(r[e+4])<<32n|BigInt(r[e+5])<<40n|BigInt(r[e+6])<<48n|BigInt(r[e+7])<<56n:BigInt(r[e])<<56n|BigInt(r[e+1])<<48n|BigInt(r[e+2])<<40n|BigInt(r[e+3])<<32n|BigInt(r[e+4])<<24n|BigInt(r[e+5])<<16n|BigInt(r[e+6])<<8n|BigInt(r[e+7])}function ar(r,e,t,n){n?(r[e]=Number(t&0xffn),r[e+1]=Number(t>>8n&0xffn),r[e+2]=Number(t>>16n&0xffn),r[e+3]=Number(t>>24n&0xffn),r[e+4]=Number(t>>32n&0xffn),r[e+5]=Number(t>>40n&0xffn),r[e+6]=Number(t>>48n&0xffn),r[e+7]=Number(t>>56n&0xffn)):(r[e]=Number(t>>56n&0xffn),r[e+1]=Number(t>>48n&0xffn),r[e+2]=Number(t>>40n&0xffn),r[e+3]=Number(t>>32n&0xffn),r[e+4]=Number(t>>24n&0xffn),r[e+5]=Number(t>>16n&0xffn),r[e+6]=Number(t>>8n&0xffn),r[e+7]=Number(t&0xffn))}function ye(r,e,t){const n=(()=>n);return Object.assign(n,L(r,"byob",e,t)),n}const or=ye(1,(r,{buffer:e,index:t})=>{e[t]=r},function*(r,e){return(yield*r(e.readExactly(1)))[0]}),d=ye(4,(r,{buffer:e,index:t,littleEndian:n})=>{nr(e,t,r,n)},function*(r,e,{littleEndian:t}){const n=yield*r(e.readExactly(4));return tr(n,0,t)}),cr=ye(4,(r,{buffer:e,index:t,littleEndian:n})=>{Qt(e,t,r,n)},function*(r,e,{littleEndian:t}){const n=yield*r(e.readExactly(4));return Xt(n,0,t)}),K=ye(8,(r,{buffer:e,index:t,littleEndian:n})=>{ar(e,t,r,n)},function*(r,e,{littleEndian:t}){const n=yield*r(e.readExactly(8));return ir(n,0,t)}),{TextEncoder:lr,TextDecoder:dr}=globalThis,ur=new lr,hr=new dr;function O(r){return ur.encode(r)}function se(r){return hr.decode(r)}const te=(r=>{const e=ne(r,{convert:se,back:O});return e.as=()=>e,e}),{AbortController:be}=globalThis,B=(()=>{const{ReadableStream:r}=globalThis;return r.from||(r.from=function(e){const t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return new r({async pull(n){const s=await t.next();if(s.done){n.close();return}n.enqueue(s.value)},async cancel(n){await t.return?.(n)}})}),(!r.prototype[Symbol.asyncIterator]||!r.prototype.values)&&(r.prototype.values=async function*(e){const t=this.getReader();try{for(;;){const{done:n,value:s}=await t.read();if(n)return;yield s}}finally{e?.preventCancel||await t.cancel(),t.releaseLock()}},r.prototype[Symbol.asyncIterator]=r.prototype.values),r})(),{WritableStream:C,TransformStream:at}=globalThis;class Z extends B{constructor(e,t,n){let s,i=!1;const a=new be;super({start:o=>{const c=e({abortSignal:a.signal,enqueue:async l=>{if(n?.({source:"producer",operation:"enqueue",value:l,phase:"start"}),a.signal.aborted){n?.({source:"producer",operation:"enqueue",value:l,phase:"ignored"});return}if(o.desiredSize===null){o.enqueue(l);return}if(i){i=!1,o.enqueue(l),n?.({source:"producer",operation:"enqueue",value:l,phase:"complete"});return}if(o.desiredSize<=0&&(n?.({source:"producer",operation:"enqueue",value:l,phase:"waiting"}),s=new S,await s.promise,a.signal.aborted)){n?.({source:"producer",operation:"enqueue",value:l,phase:"ignored"});return}o.enqueue(l),n?.({source:"producer",operation:"enqueue",value:l,phase:"complete"})},close(){if(n?.({source:"producer",operation:"close",explicit:!0,phase:"start"}),a.signal.aborted){n?.({source:"producer",operation:"close",explicit:!0,phase:"ignored"});return}o.close(),n?.({source:"producer",operation:"close",explicit:!0,phase:"complete"})},error(l){n?.({source:"producer",operation:"error",explicit:!0,phase:"start"}),o.error(l),n?.({source:"producer",operation:"error",explicit:!0,phase:"complete"})}});c&&"then"in c&&c.then(()=>{n?.({source:"producer",operation:"close",explicit:!1,phase:"start"});try{o.close(),n?.({source:"producer",operation:"close",explicit:!1,phase:"complete"})}catch{n?.({source:"producer",operation:"close",explicit:!1,phase:"ignored"})}},l=>{n?.({source:"producer",operation:"error",explicit:!1,phase:"start"}),o.error(l),n?.({source:"producer",operation:"error",explicit:!1,phase:"complete"})})},pull:()=>{n?.({source:"consumer",operation:"pull",phase:"start"}),s?s.resolve():t?.highWaterMark===0&&(i=!0),n?.({source:"consumer",operation:"pull",phase:"complete"})},cancel:o=>{n?.({source:"consumer",operation:"cancel",phase:"start"}),a.abort(o),s?.resolve(),n?.({source:"consumer",operation:"cancel",phase:"complete"})}},t)}}function fr(r){try{return r.close(),!0}catch{return!1}}async function wr(r){try{return await r.cancel(),!0}catch{return!1}}class me{#e;#t=0;#r=0;#n=0;get position(){return this.#n}stream;reader;constructor(e){this.stream=e,this.reader=e.getReader()}#s(e){if(!this.#e)return;const t=this.#e.subarray(this.#t,this.#t+e);return this.#r>e?(this.#n+=e,this.#t+=e,this.#r-=e,t):(this.#n+=this.#r,this.#e=void 0,this.#t=0,this.#r=0,t)}async#i(e){const{done:t,value:n}=await this.reader.read();if(t)throw new we;return n.length>e?(this.#e=n,this.#t=e,this.#r=n.length-e,this.#n+=e,n.subarray(0,e)):(this.#n+=n.length,n)}iterateExactly(e){let t=this.#e?0:1;return{next:()=>{switch(t){case 0:{const n=this.#s(e);return n.length===e?t=2:(e-=n.length,t=1),{done:!1,value:n}}case 1:return t=3,{done:!1,value:this.#i(e).then(n=>(n.length===e?t=2:(e-=n.length,t=1),n))};case 2:return{done:!0,value:void 0};case 3:throw new Error("Can't call `next` before previous Promise resolves");default:throw new Error("unreachable")}}}}readExactly=Ne(function*(e,t){let n,s=0;const i=this.#s(t);if(i){if(i.length===t)return i;n=new Uint8Array(t),n.set(i,s),s+=i.length,t-=i.length}else n=new Uint8Array(t);for(;t>0;){const a=yield*e(this.#i(t));n.set(a,s),s+=a.length,t-=a.length}return n});release(){return this.#r>0?new Z(async e=>{const t=this.#e.subarray(this.#t);for(await e.enqueue(t),e.abortSignal.addEventListener("abort",()=>{wr(this.reader)});;){const{done:n,value:s}=await this.reader.read();if(n)return;await e.enqueue(s)}}):(this.reader.releaseLock(),this.stream)}async cancel(e){await this.reader.cancel(e)}}class pr{#e;get readable(){return this.#e}#t;get writable(){return this.#t}constructor(e){let t,n;const s=new me(new Z(i=>{t=i}));this.#e=new B({async pull(i){try{const a=await e(s);i.enqueue(a)}catch(a){if(a instanceof Be){i.close();return}throw a}},cancel:i=>n.error(i)}),this.#t=new C({start(i){n=i},async write(i){await t.enqueue(i)},abort(){t.close()},close(){t.close()}})}}class ce{#e="";#t=new S;#r=new C({write:e=>{this.#e+=e},close:()=>{this.#t.resolve(this.#e),this.#n.enqueue(this.#e),this.#n.close()},abort:e=>{this.#t.reject(e),this.#n.error(e)}});get writable(){return this.#r}#n;#s=new B({start:e=>{this.#n=e}});get readable(){return this.#s}constructor(){Object.defineProperties(this.#s,{then:{get:()=>this.#t.promise.then.bind(this.#t.promise)},catch:{get:()=>this.#t.promise.catch.bind(this.#t.promise)},finally:{get:()=>this.#t.promise.finally.bind(this.#t.promise)}})}}class ke{#e=[];#t=new S;#r=new C({write:e=>{this.#e.push(e)},close:()=>{let e,t=0;switch(this.#e.length){case 0:e=x;break;case 1:e=this.#e[0];break;default:e=new Uint8Array(this.#e.reduce((n,s)=>n+s.length,0));for(const n of this.#e)e.set(n,t),t+=n.length;break}this.#t.resolve(e),this.#n.enqueue(e),this.#n.close()},abort:e=>{this.#t.reject(e),this.#n.error(e)}});get writable(){return this.#r}#n;#s=new B({start:e=>{this.#n=e}});get readable(){return this.#s}constructor(){Object.defineProperties(this.#s,{then:{get:()=>this.#t.promise.then.bind(this.#t.promise)},catch:{get:()=>this.#t.promise.catch.bind(this.#t.promise)},finally:{get:()=>this.#t.promise.finally.bind(this.#t.promise)}})}}class ge extends B{static async enqueue(e,t){const n=new T(t);e.enqueue(n),await n.consumed}constructor(e,t){let n,s;t&&(s={},"highWaterMark"in t&&(s.highWaterMark=t.highWaterMark),"size"in t&&(s.size=i=>t.size(i.value))),super({start(i){return n={enqueue(a){return ge.enqueue(i,a)},close(){i.close()},error(a){i.error(a)}},e.start?.(n)},pull(){return e.pull?.(n)},cancel(i){return e.cancel?.(i)}},s)}}class yr extends B{constructor(e,t,n){const s=e.getReader({mode:"byob"});let i=new Uint8Array(t);super({async pull(a){const{done:o,value:c}=await s.read(i,{min:n});if(o){a.close();return}await ge.enqueue(a,c),i=new Uint8Array(c.buffer)},cancel(a){return s.cancel(a)}})}}class br extends C{constructor(e){const t=e.getWriter();super({write(n){return n.tryConsume(s=>t.write(s))},abort(n){return t.abort(n)},close(){return t.close()}})}}class mr extends C{static async write(e,t){const n=new T(t);await e.write(n),await n.consumed}constructor(e,t){let n;t&&(n={},"highWaterMark"in t&&(n.highWaterMark=t.highWaterMark),"size"in t&&(n.size=s=>t.size(s instanceof T?s.value:s))),super({start(s){return e.start?.(s)},write(s,i){return s.tryConsume(a=>e.write?.(a,i))},abort(s){return e.abort?.(s)},close(){return e.close?.()}},n)}}const{console:Oe}=globalThis,gr=Oe?.createTask?.bind(Oe)??(()=>({run(r){return r()}}));class T{static WritableStream=mr;static WrapWritableStream=br;static ReadableStream=ge;static WrapByteReadableStream=yr;#e;#t;value;consumed;constructor(e){this.#e=gr("Consumable"),this.value=e,this.#t=new S,this.consumed=this.#t.promise}consume(){this.#t.resolve()}error(e){this.#t.reject(e)}tryConsume(e){try{let t=this.#e.run(()=>e(this.value));return De(t)?t=t.then(n=>(this.#t.resolve(),n),n=>{throw this.#t.reject(n),n}):this.#t.resolve(),t}catch(t){throw this.#t.reject(t),t}}}function ot(r,e){return r instanceof T?r.tryConsume(e):e(r)}class X extends C{constructor(e,t){let n;t&&(n={},"highWaterMark"in t&&(n.highWaterMark=t.highWaterMark),"size"in t&&(n.size=s=>t.size(s instanceof T?s.value:s))),super({start(s){return e.start?.(s)},write(s,i){return ot(s,a=>e.write?.(a,i))},abort(s){return e.abort?.(s)},close(){return e.close?.()}},n)}}class ct{#e;#t;#r;#n;constructor(e){this.#e=e,this.#t=new Uint8Array(e),this.#r=0,this.#n=e}*push(e){let t=0,n=e.length;if(this.#r!==0)if(n>=this.#n){if(this.#t.set(e.subarray(0,this.#n),this.#r),t+=this.#n,n-=this.#n,yield this.#t,this.#r=0,this.#n=this.#e,n===0)return}else{this.#t.set(e,this.#r),this.#r+=n,this.#n-=n;return}for(;n>=this.#e;){const s=t+this.#e;yield e.subarray(t,s),t=s,n-=this.#e}n>0&&(this.#t.set(e.subarray(t),this.#r),this.#r+=n,this.#n-=n)}flush(){if(this.#r===0)return;const e=this.#t.subarray(0,this.#r);return this.#r=0,this.#n=this.#e,e}}class Sr extends at{constructor(e,t=!1){const n=t?new ct(e):void 0;super({async transform(s,i){await ot(s,async a=>{if(n)for(const o of n.push(a))await T.ReadableStream.enqueue(i,o);else{let o=0,c=a.length;for(;c>0;){const l=o+e;await T.ReadableStream.enqueue(i,a.subarray(o,l)),o=l,c-=e}}})},flush(s){if(n){const i=n.flush();i&&s.enqueue(i)}}})}}function Er(r,e){return"start"in r?r.start(e):typeof r=="function"?r(e):r}class xr extends B{readable;#e;constructor(e,t){super({start:async n=>{const s=await Er(e,n);this.readable=s,this.#e=this.readable.getReader()},pull:async n=>{const{done:s,value:i}=await this.#e.read().catch(a=>{throw"error"in e&&e.error(a),a});s?(n.close(),"close"in e&&await e.close?.()):n.enqueue(i)},cancel:async n=>{await this.#e.cancel(n),"cancel"in e&&await e.cancel?.(n)}},t)}}const Ke=()=>{};class vr{#e=[];#t=[];#r=!1;get writableClosed(){return this.#r}#n=new S;get closed(){return this.#n.promise}#s;constructor(e){this.#s=e??{}}wrapReadable(e,t){return new xr({start:n=>(this.#e.push(n),e),cancel:async()=>{await this.close()},close:async()=>{await this.dispose()}},t)}createWritable(e){const t=e.getWriter();return this.#t.push(t),new C({write:async n=>{await t.write(n)},abort:async n=>{await t.abort(n),await this.close()},close:async()=>{await t.close().catch(Ke),await this.close()}})}async close(){if(!this.#r){this.#r=!0,await this.#s.close?.()!==!1&&await this.dispose();for(const e of this.#t)e.close().catch(Ke)}}async dispose(){this.#r=!0,this.#n.resolve();for(const e of this.#e)fr(e);await this.#s.dispose?.()}}const kr=globalThis,le=kr.TextDecoderStream;function Ar(r,e){const t=e.writable.getWriter(),n=e.readable.pipeTo(r);return new C({async write(s){await t.write(s)},async close(){await t.close(),await n}})}class lt extends pr{constructor(e){super(t=>e.deserialize(t))}}class Ir{#e=[];constructor(){this.dispose=this.dispose.bind(this)}addDisposable(e){return this.#e.push(e),e}dispose(){for(const e of this.#e)e.dispose();this.#e=[]}}class Ae{listeners=[];constructor(){this.event=this.event.bind(this)}addEventListener(e){this.listeners.push(e);const t=()=>{const n=this.listeners.indexOf(e);n!==-1&&this.listeners.splice(n,1)};return t.dispose=t,t}event=(e,t,...n)=>{const s={listener:e,thisArg:t,args:n};return this.addEventListener(s)};fire(e){for(const t of this.listeners.slice())t.listener.call(t.thisArg,e,...t.args)}dispose(){this.listeners.length=0}}const Fe=Symbol("undefined");class Tr extends Ae{#e=Fe;addEventListener(e){return this.#e!==Fe&&e.listener.call(e.thisArg,this.#e,...e.args),super.addEventListener(e)}fire(e){this.#e=e,super.fire(e)}}class Ue extends Ir{#e;get adb(){return this.#e}constructor(e){super(),this.#e=e}}const Cr=A({version:d},{littleEndian:!0}),Lr=A({bpp:d,size:d,width:d,height:d,red_offset:d,red_length:d,blue_offset:d,blue_length:d,green_offset:d,green_length:d,alpha_offset:d,alpha_length:d,data:ne("size")},{littleEndian:!0}),Pr=A({bpp:d,colorSpace:d,size:d,width:d,height:d,red_offset:d,red_length:d,blue_offset:d,blue_length:d,green_offset:d,green_length:d,alpha_offset:d,alpha_length:d,data:ne("size")},{littleEndian:!0});class dt extends Error{constructor(e,t){super(e,t)}}class Rr extends dt{constructor(e){super(`Unsupported FrameBuffer version ${e}`)}}class Dr extends dt{constructor(){super("FrameBuffer is disabled by current app")}}async function Nr(r){const e=await r.createSocket("framebuffer:"),t=new me(e.readable);let n;try{({version:n}=await Cr.deserialize(t))}catch(s){throw s instanceof Be?new Dr:s}switch(n){case 1:return await Lr.deserialize(t);case 2:return await Pr.deserialize(t);default:throw new Rr(n)}}class Br extends Ue{reboot(e=""){return this.adb.createSocketAndWait(`reboot:${e}`)}bootloader(){return this.reboot("bootloader")}fastboot(){return this.reboot("fastboot")}recovery(){return this.reboot("recovery")}sideload(){return this.reboot("sideload")}qualcommEdlMode(){return this.reboot("edl")}powerOff(){return this.adb.subprocess.noneProtocol.spawnWaitText(["reboot","-p"])}powerButton(e=!1){const t=["input","keyevent"];return e&&t.push("--longpress"),t.push("POWER"),this.adb.subprocess.noneProtocol.spawnWaitText(t)}samsungOdin(){return this.reboot("download")}}class ut{#e;#t=[];constructor(e=!1){this.#e=e}wait(){if(!this.#e&&(this.#e=!0,this.#t.length===0))return Promise.resolve();const e=new S;return this.#t.push(e),e.promise}notifyOne(){this.#t.length!==0?this.#t.pop().resolve():this.#e=!1}dispose(){for(const e of this.#t)e.reject(new Error("The AutoResetEvent has been disposed"));this.#t.length=0}}const[Ss,m,H]=(()=>{const r=[],e=[];function n(s,i){const a=s.charCodeAt(0),o=i.charCodeAt(0);for(let c=a;c<=o;c+=1)r[c]=e.length,e.push(c)}return n("A","Z"),n("a","z"),n("0","9"),n("+","+"),n("/","/"),[r,e,61]})();function ht(r){const e=r%3,t=e!==0?3-e:0;return[(r+t)/3*4,t]}function zr(r,e){const[t,n]=ht(r.length);if(e){if(e.length<t)throw new TypeError("output buffer is too small");if(e=e.subarray(0,t),r.buffer!==e.buffer)Ee(r,e,n);else if(e.byteOffset+e.length-(n+1)<=r.byteOffset+r.length)Ee(r,e,n);else if(e.byteOffset>=r.byteOffset-1)Ur(r,e,n);else throw new TypeError("input and output cannot overlap");return t}else return e=new Uint8Array(t),Ee(r,e,n),e}function Ee(r,e,t){let n=0,s=0;for(;n<r.length-2;){const i=r[n];n+=1;const a=r[n];n+=1;const o=r[n];n+=1,e[s]=m[i>>2],s+=1,e[s]=m[(i&3)<<4|a>>4],s+=1,e[s]=m[(a&15)<<2|o>>6],s+=1,e[s]=m[o&63],s+=1}if(t===2){const i=r[n];n+=1,e[s]=m[i>>2],s+=1,e[s]=m[(i&3)<<4],s+=1,e[s]=H,s+=1,e[s]=H}else if(t===1){const i=r[n];n+=1;const a=r[n];n+=1,e[s]=m[i>>2],s+=1,e[s]=m[(i&3)<<4|a>>4],s+=1,e[s]=m[(a&15)<<2],s+=1,e[s]=H}}function Ur(r,e,t){let n=r.length-1,s=e.length-1;if(t===2){const i=r[n];n-=1,e[s]=H,s-=1,e[s]=H,s-=1,e[s]=m[(i&3)<<4],s-=1,e[s]=m[i>>2],s-=1}else if(t===1){const i=r[n];n-=1;const a=r[n];n-=1,e[s]=H,s-=1,e[s]=m[(i&15)<<2],s-=1,e[s]=m[(a&3)<<4|i>>4],s-=1,e[s]=m[a>>2],s-=1}for(;n>=0;){const i=r[n];n-=1;const a=r[n];n-=1;const o=r[n];n-=1,e[s]=m[i&63],s-=1,e[s]=m[(a&15)<<2|i>>6],s-=1,e[s]=m[(o&3)<<4|a>>4],s-=1,e[s]=m[o>>2],s-=1}}function _r(r){if(r<48)throw new TypeError(`Invalid hex char ${r}`);if(r<58)return r-48;if(r<65)throw new TypeError(`Invalid hex char ${r}`);if(r<71)return r-55;if(r<97)throw new TypeError(`Invalid hex char ${r}`);if(r<103)return r-87;throw new TypeError(`Invalid hex char ${r}`)}function Wr(r){let e=0;for(let t=0;t<r.length;t+=1)e=e<<4|_r(r[t]);return e}const Mr=()=>{};function ft(...r){throw new Error(`Unreachable. Arguments:
`+r.join(`
`))}function qr(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t+=1)if(r[t]!==e[t])return!1;return!0}const wt=A({length:te(4),content:te({field:"length",convert(r){return Number.parseInt(r,16)},back(r){return r.toString(16).padStart(4,"0")}})},{littleEndian:!0});class pt extends Error{constructor(e){super(e)}}class $r extends pt{constructor(){super("ADB reverse tunnel is not supported on this device when connected wirelessly.")}}const jr=ze(wt,{},{postDeserialize(r){throw r.content==="more than one device/emulator"?new $r:new pt(r.content)}});function Vr(r){let e=0;for(const t of r){if(t<48||t>57)return e;e=e*10+t-48}return e}const Or=O("OKAY");class Kr extends Ue{#e=new Map;async createBufferedStream(e){const t=await this.adb.createSocket(e);return new me(t.readable)}async sendRequest(e){const t=await this.createBufferedStream(e),n=await t.readExactly(4);return qr(n,Or)||await jr.deserialize(t),t}async list(){const e=await this.createBufferedStream("reverse:list-forward");return(await wt.deserialize(e)).content.split(`
`).filter(n=>!!n).map(n=>{const[s,i,a]=n.split(" ");return{deviceSerial:s,localName:i,remoteName:a}})}async addExternal(e,t){const n=await this.sendRequest(`reverse:forward:${e};${t}`);if(e.startsWith("tcp:")){const s=n.position;try{const i=Wr(await n.readExactly(4));e=`tcp:${Vr(await n.readExactly(i))}`}catch(i){if(!(i instanceof we&&n.position===s))throw i}}return e}async add(e,t,n){n=await this.adb.transport.addReverseTunnel(t,n);try{return e=await this.addExternal(e,n),this.#e.set(e,n),e}catch(s){throw await this.adb.transport.removeReverseTunnel(n),s}}async remove(e){const t=this.#e.get(e);t&&await this.adb.transport.removeReverseTunnel(t),await this.sendRequest(`reverse:killforward:${e}`)}async removeAll(){await this.adb.transport.clearReverseTunnels(),this.#e.clear(),await this.sendRequest("reverse:killforward-all")}}class Fr{#e;get stdin(){return this.#e.writable}get output(){return this.#e.readable}#t;get exited(){return this.#t}constructor(e,t){if(this.#e=e,t){const n=new S;this.#e.closed.then(()=>n.resolve(void 0),s=>n.reject(s)),t.addEventListener("abort",()=>{n.reject(t.reason),this.#e.close()}),this.#t=n.promise}else this.#t=this.#e.closed}kill(){return this.#e.close()}}class Gr{#e;#t;#r;get input(){return this.#r}get output(){return this.#e.readable}get exited(){return this.#e.closed}constructor(e){this.#e=e,this.#t=this.#e.writable.getWriter(),this.#r=new X({write:t=>this.#t.write(t)})}sigint(){return this.#t.write(new Uint8Array([3]))}kill(){return this.#e.close()}}function Ie(r){let e="";e+="'";let t=0;for(;;){const n=r.indexOf("'",t);if(n===-1){e+=r.substring(t);break}e+=r.substring(t,n),e+=String.raw`'\''`,t=n+1}return e+="'",e}function yt(r){const e=[];let t,n=!1,s=0;for(let i=0,a=r.length;i<a;i+=1){if(n){n=!1;continue}const o=r.charAt(i);switch(o){case" ":!t&&i!==s&&(e.push(r.substring(s,i)),s=i+1);break;case"'":case'"':t?o===t&&(t=void 0):t=o;break;case"\\":n=!0;break}}return s<r.length&&e.push(r.substring(s)),e}class Hr{#e;constructor(e){this.#e=e}spawn(e,t){return t?.throwIfAborted(),typeof e=="string"&&(e=yt(e)),this.#e(e,t)}async spawnWait(e){return await(await this.spawn(e)).output.pipeThrough(new ke)}async spawnWaitText(e){return await(await this.spawn(e)).output.pipeThrough(new le).pipeThrough(new ce)}}class Yr extends Hr{#e;get adb(){return this.#e}constructor(e){super(async(t,n)=>{const s=await this.#e.createSocket(`exec:${t.join(" ")}`);if(n?.aborted)throw await s.close(),n.reason;return new Fr(s,n)}),this.#e=e}async pty(e){return e===void 0?e="":Array.isArray(e)&&(e=e.join(" ")),new Gr(await this.#e.createSocket(`shell:${e}`))}}const b={ShellV2:"shell_v2",Cmd:"cmd",StatV2:"stat_v2",ListV2:"ls_v2",FixedPushMkdir:"fixed_push_mkdir",Abb:"abb",AbbExec:"abb_exec",SendReceiveV2:"sendrecv_v2",DelayedAck:"delayed_ack"},M={Stdin:0,Stdout:1,Stderr:2,Exit:3,WindowSizeChange:5},J=A({id:or(),data:ne(d)},{littleEndian:!0});class Zr{#e;#t;#r;get stdin(){return this.#r}#n;get stdout(){return this.#n}#s;get stderr(){return this.#s}#i;get exited(){return this.#i}constructor(e,t){this.#e=e;let n,s;this.#n=new Z(a=>{n=a}),this.#s=new Z(a=>{s=a});const i=new S;this.#i=i.promise,e.readable.pipeThrough(new lt(J)).pipeTo(new C({write:async a=>{switch(a.id){case M.Exit:i.resolve(a.data[0]);break;case M.Stdout:await n.enqueue(a.data);break;case M.Stderr:await s.enqueue(a.data);break}}})).then(()=>{n.close(),s.close(),i.reject(new Error("Socket ended without exit message"))},a=>{n.error(a),s.error(a),i.reject(a)}),t&&t.addEventListener("abort",()=>{i.reject(t.reason),this.#e.close()}),this.#t=this.#e.writable.getWriter(),this.#r=new X({write:async a=>{await this.#t.write(J.serialize({id:M.Stdin,data:a}))}})}kill(){return this.#e.close()}}class Xr{#e;#t;#r;get input(){return this.#r}#n;get output(){return this.#n}#s=new S;get exited(){return this.#s.promise}constructor(e){this.#e=e;let t;this.#n=new Z(n=>{t=n}),e.readable.pipeThrough(new lt(J)).pipeTo(new C({write:async n=>{switch(n.id){case M.Exit:this.#s.resolve(n.data[0]);break;case M.Stdout:await t.enqueue(n.data);break}}})).then(()=>{t.close(),this.#s.reject(new Error("Socket ended without exit message"))},n=>{t.error(n),this.#s.reject(n)}),this.#t=this.#e.writable.getWriter(),this.#r=new X({write:n=>this.#i(n)})}#i(e){return this.#t.write(J.serialize({id:M.Stdin,data:e}))}async resize(e,t){await this.#t.write(J.serialize({id:M.WindowSizeChange,data:O(`${e}x${t},0x0\0`)}))}sigint(){return this.#i(new Uint8Array([3]))}kill(){return this.#e.close()}}class Qr{#e;constructor(e){this.#e=e}spawn(e,t){return t?.throwIfAborted(),typeof e=="string"&&(e=yt(e)),this.#e(e,t)}async spawnWait(e){const t=await this.spawn(e),[n,s,i]=await Promise.all([t.stdout.pipeThrough(new ke),t.stderr.pipeThrough(new ke),t.exited]);return{stdout:n,stderr:s,exitCode:i}}async spawnWaitText(e){const t=await this.spawn(e),[n,s,i]=await Promise.all([t.stdout.pipeThrough(new le).pipeThrough(new ce),t.stderr.pipeThrough(new le).pipeThrough(new ce),t.exited]);return{stdout:n,stderr:s,exitCode:i}}}class Jr extends Qr{#e;get adb(){return this.#e}get isSupported(){return this.#e.canUseFeature(b.ShellV2)}constructor(e){super(async(t,n)=>{const s=await this.#e.createSocket(`shell,v2,raw:${t.join(" ")}`);if(n?.aborted)throw await s.close(),n.reason;return new Zr(s,n)}),this.#e=e}async pty(e){let t="shell,v2,pty";return e?.terminalType&&(t+=",TERM="+e.terminalType),t+=":",e&&(typeof e.command=="string"?t+=e.command:Array.isArray(e.command)&&(t+=e.command.join(" "))),new Xr(await this.#e.createSocket(t))}}class en{#e;get adb(){return this.#e}#t;get noneProtocol(){return this.#t}#r;get shellProtocol(){return this.#r}constructor(e){this.#e=e,this.#t=new Yr(e),e.canUseFeature(b.ShellV2)&&(this.#r=new Jr(e))}}function tn(r){const e=new Uint8Array(r.length);for(let t=0;t<r.length;t+=1)e[t]=r.charCodeAt(t);return e}function y(r){const e=tn(r);return pe(e,0)}const I={Entry:y("DENT"),Entry2:y("DNT2"),Lstat:y("STAT"),Stat:y("STA2"),Lstat2:y("LST2"),Done:y("DONE"),Data:y("DATA"),Ok:y("OKAY"),Fail:y("FAIL")};class rn extends Error{}const bt=A({message:te(d)},{littleEndian:!0,postDeserialize(r){throw new rn(r.message)}});async function de(r,e,t){typeof e=="string"&&(e=y(e));const n=await r.readExactly(4);switch(pe(n,0)){case I.Fail:throw await bt.deserialize(r),new Error("Unreachable");case e:return await t.deserialize(r);default:throw new Error(`Expected '${e}', but got '${se(n)}'`)}}async function*ue(r,e,t){for(typeof e=="string"&&(e=y(e));;){const n=await r.readExactly(4);switch(pe(n,0)){case I.Fail:await bt.deserialize(r),ft();case I.Done:await r.readExactly(t.size);return;case e:yield await t.deserialize(r);break;default:throw new Error(`Expected '${e}' or '${I.Done}', but got '${se(n)}'`)}}}const R={List:y("LIST"),ListV2:y("LIS2"),Send:y("SEND"),SendV2:y("SND2"),Lstat:y("STAT"),Stat:y("STA2"),LstatV2:y("LST2"),Data:y("DATA"),Done:y("DONE"),Receive:y("RECV")},Ge=A({id:d,arg:d},{littleEndian:!0});async function N(r,e,t){if(typeof e=="string"&&(e=y(e)),typeof t=="number"){await r.write(Ge.serialize({id:e,arg:t}));return}typeof t=="string"&&(t=O(t)),await r.write(Ge.serialize({id:e,arg:t.length})),await r.write(t)}const mt={File:8},gt=A({mode:d,size:d,mtime:d},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return this.mode&4095}},postDeserialize(r){if(r.mode===0&&r.size===0&&r.mtime===0)throw new Error("lstat error");return r}}),St={SUCCESS:0,EACCES:13,EEXIST:17,EFAULT:14,EFBIG:27,EINTR:4,EINVAL:22,EIO:5,EISDIR:21,ELOOP:40,EMFILE:24,ENAMETOOLONG:36,ENFILE:23,ENOENT:2,ENOMEM:12,ENOSPC:28,ENOTDIR:20,EOVERFLOW:75,EPERM:1,EROFS:30,ETXTBSY:26},nn=Object.fromEntries(Object.entries(St).map(([r,e])=>[e,r])),_e=A({error:d(),dev:K,ino:K,mode:d,nlink:d,uid:d,gid:d,size:K,atime:K,mtime:K,ctime:K},{littleEndian:!0,extra:{get type(){return this.mode>>12},get permission(){return this.mode&4095}},postDeserialize(r){if(r.error)throw new Error(nn[r.error]);return r}});async function sn(r,e,t){const n=await r.lock();try{if(t)return await N(n,R.LstatV2,e),await de(n,I.Lstat2,_e);{await N(n,R.Lstat,e);const s=await de(n,I.Lstat,gt);return{mode:s.mode,size:BigInt(s.size),mtime:BigInt(s.mtime),get type(){return s.type},get permission(){return s.permission}}}}finally{n.release()}}async function an(r,e){const t=await r.lock();try{return await N(t,R.Stat,e),await de(t,I.Stat,_e)}finally{t.release()}}const on=ze(gt,{name:te(d)}),cn=ze(_e,{name:te(d)});async function*ln(r,e){const t=await r.lock();try{await N(t,R.ListV2,e);for await(const n of ue(t,I.Entry2,cn))n.error===St.SUCCESS&&(yield n)}finally{t.release()}}async function*dn(r,e){const t=await r.lock();try{await N(t,R.List,e);for await(const n of ue(t,I.Entry,on))yield n}finally{t.release()}}async function*un(r,e,t){if(t)yield*ln(r,e);else for await(const n of dn(r,e))yield{mode:n.mode,size:BigInt(n.size),mtime:BigInt(n.mtime),get type(){return n.type},get permission(){return n.permission},name:n.name}}const He=A({data:ne(d)},{littleEndian:!0});async function*hn(r,e){const t=await r.lock();let n=!1;try{await N(t,R.Receive,e);for await(const s of ue(t,I.Data,He))yield s.data;n=!0}catch(s){throw n=!0,s}finally{if(!n)for await(const s of ue(t,I.Data,He));t.release()}}function fn(r,e){return B.from(hn(r,e))}const Et=64*1024,wn=A({unused:d},{littleEndian:!0});async function xt(r,e,t,n){const s=new be;e.pipeThrough(new Sr(t,!0)).pipeTo(new X({write(i){return N(r,R.Data,i)}}),{signal:s.signal}).then(async()=>{await N(r,R.Done,n),await r.flush()},Mr),await de(r,I.Ok,wn).catch(i=>{throw s.abort(),i})}async function pn({socket:r,filename:e,file:t,type:n=mt.File,permission:s=438,mtime:i=Date.now()/1e3|0,packetSize:a=Et}){const o=await r.lock();try{const c=n<<12|s,l=`${e},${c.toString()}`;await N(o,R.Send,l),await xt(o,t,a,i)}finally{o.release()}}const Ye={None:0,Brotli:1,Lz4:2,Zstd:4,DryRun:2147483648},yn=A({id:d,mode:d,flags:d()},{littleEndian:!0});async function bn({socket:r,filename:e,file:t,type:n=mt.File,permission:s=438,mtime:i=Date.now()/1e3|0,packetSize:a=Et,dryRun:o=!1}){const c=await r.lock();try{await N(c,R.SendV2,e);const l=n<<12|s;let u=Ye.None;o&&(u|=Ye.DryRun),await c.write(yn.serialize({id:R.SendV2,mode:l,flags:u})),await xt(c,t,a,i)}finally{c.release()}}function mn(r){if(r.v2)return bn(r);if(r.dryRun)throw new Error("dryRun is not supported in v1");return pn(r)}class gn{#e;#t;#r;#n=new ut;#s;get position(){return this.#t.position}constructor(e,t,n,s){this.#e=e,this.#t=t,this.#r=s,this.#s=new ct(n)}#i(e){return T.WritableStream.write(this.#e,e)}async flush(){try{await this.#n.wait();const e=this.#s.flush();e&&await this.#i(e)}finally{this.#n.notifyOne()}}async write(e){try{await this.#n.wait();for(const t of this.#s.push(e))await this.#i(t)}finally{this.#n.notifyOne()}}async readExactly(e){return await this.flush(),await this.#t.readExactly(e)}release(){this.#s.flush(),this.#r.notifyOne()}async close(){await this.#t.cancel()}}class Sn{#e=new ut;#t;#r;constructor(e,t){this.#t=e,this.#r=new gn(e.writable.getWriter(),new me(e.readable),t,this.#e)}async lock(){return await this.#e.wait(),this.#r}async close(){await this.#r.close(),await this.#t.close()}}function En(r){const e=r.lastIndexOf("/");if(e===-1)throw new Error("Invalid path");return e===0?"/":r.substring(0,e)}class xn{_adb;_socket;#e;#t;#r;#n;#s;get supportsStat(){return this.#e}get supportsListV2(){return this.#t}get fixedPushMkdir(){return this.#r}get supportsSendReceiveV2(){return this.#n}get needPushMkdirWorkaround(){return this.#s}constructor(e,t){this._adb=e,this._socket=new Sn(t,e.maxPayloadSize),this.#e=e.canUseFeature(b.StatV2),this.#t=e.canUseFeature(b.ListV2),this.#r=e.canUseFeature(b.FixedPushMkdir),this.#n=e.canUseFeature(b.SendReceiveV2),this.#s=this._adb.canUseFeature(b.ShellV2)&&!this.fixedPushMkdir}async lstat(e){return await sn(this._socket,e,this.#e)}async stat(e){if(!this.#e)throw new Error("Not supported");return await an(this._socket,e)}async isDirectory(e){try{return await this.lstat(e+"/"),!0}catch{return!1}}opendir(e){return un(this._socket,e,this.supportsListV2)}async readdir(e){const t=[];for await(const n of this.opendir(e))t.push(n);return t}read(e){return fn(this._socket,e)}async write(e){this.needPushMkdirWorkaround&&await this._adb.subprocess.noneProtocol.spawnWait(["mkdir","-p",Ie(En(e.filename))]),await mn({v2:this.supportsSendReceiveV2,socket:this._socket,...e})}lockSocket(){return this._socket.lock()}dispose(){return this._socket.close()}}function Ze(r){if(!(!r||r==="0"))return Number.parseInt(r,10)}class vn extends Ue{async getListenAddresses(){const e=await this.adb.getProp("service.adb.listen_addrs"),t=await this.adb.getProp("service.adb.tcp.port"),n=await this.adb.getProp("persist.adb.tcp.port");return{serviceListenAddresses:e!=""?e.split(","):[],servicePort:Ze(t),persistPort:Ze(n)}}async setPort(e){if(e<=0)throw new TypeError(`Invalid port ${e}`);const t=await this.adb.createSocketAndWait(`tcpip:${e}`);if(t!==`restarting in TCP mode port: ${e}
`)throw new Error(t);return t}async disable(){const e=await this.adb.createSocketAndWait("usb:");if(e!==`restarting in USB mode
`)throw new Error(e);return e}}class kn{#e;get transport(){return this.#e}get serial(){return this.#e.serial}get maxPayloadSize(){return this.#e.maxPayloadSize}get banner(){return this.#e.banner}get disconnected(){return this.#e.disconnected}get clientFeatures(){return this.#e.clientFeatures}get deviceFeatures(){return this.banner.features}subprocess;power;reverse;tcpip;constructor(e){this.#e=e,this.subprocess=new en(this),this.power=new Br(this),this.reverse=new Kr(this),this.tcpip=new vn(this)}canUseFeature(e){return this.clientFeatures.includes(e)&&this.deviceFeatures.includes(e)}async createSocket(e){return this.#e.connect(e)}async createSocketAndWait(e){return await(await this.createSocket(e)).readable.pipeThrough(new le).pipeThrough(new ce)}getProp(e){return this.subprocess.noneProtocol.spawnWaitText(["getprop",e]).then(t=>t.trim())}rm(e,t){const n=["rm"];if(t?.recursive&&n.push("-r"),t?.force&&n.push("-f"),Array.isArray(e))for(const s of e)n.push(Ie(s));else n.push(Ie(e));return n.push("</dev/null"),this.subprocess.noneProtocol.spawnWaitText(n)}async sync(){const e=await this.createSocket("sync:");return new xn(this,e)}async framebuffer(){return Nr(this)}async close(){await this.#e.close()}}const ae={Product:"ro.product.name",Model:"ro.product.model",Device:"ro.product.device",Features:"features"};class We{static parse(e){let t,n,s,i=[];const a=e.split("::");if(a.length>1){const o=a[1];for(const c of o.split(";")){if(!c)continue;const l=c.split("=");if(l.length!==2)continue;const[u,p]=l;switch(u){case ae.Product:t=p;break;case ae.Model:n=p;break;case ae.Device:s=p;break;case ae.Features:i=p.split(",");break}}}return new We(t,n,s,i)}#e;get product(){return this.#e}#t;get model(){return this.#t}#r;get device(){return this.#r}#n=[];get features(){return this.#n}constructor(e,t,n,s){this.#e=e,this.#t=t,this.#r=n,this.#n=s}}function Te(r,e,t){let n=0n;for(let s=e;s<e+t;s+=8){n<<=64n;const i=sr(r,s);n|=i}return n}function Ce(r,e,t,n,s){if(s)for(;n>0n;)Jt(r,e,n),e+=8,n>>=64n;else{let i=e+t-8;for(;n>0n;)er(r,i,n),i-=8,n>>=64n}}const An=38,In=2048/8,Tn=303,Cn=2048/8;function vt(r){const e=Te(r,An,In),t=Te(r,Tn,Cn);return[e,t]}function Xe(r,e){const t=r%e;return t>0?t:t+e}function Ln(r,e){if(r=Xe(r,e),!r||e<2)return NaN;const t=[];let n=e;for(;n;)[r,n]=[n,r%n],t.push({a:r,b:n});if(r!==1)return NaN;let s=1,i=0;for(let a=t.length-2;a>=0;a-=1)[s,i]=[i,s-i*Math.floor(t[a].a/t[a].b)];return Xe(i,e)}const j=2048/8,Pn=j/4;function kt(){return 8+j+j+4}function Rn(r,e){let t;const n=kt();if(!e)e=new Uint8Array(n),t="Uint8Array";else{if(e.length<n)throw new TypeError("output buffer is too small");t="number"}const s=new DataView(e.buffer,e.byteOffset,e.length);let i=0;s.setUint32(i,Pn,!0),i+=4;const[a]=vt(r),o=-Ln(Number(a%2n**32n),2**32);s.setInt32(i,o,!0),i+=4,Ce(e,i,j,a,!0),i+=j;const c=2n**4096n%a;return Ce(e,i,j,c,!0),i+=j,s.setUint32(i,65537,!0),i+=4,t==="Uint8Array"?e:n}function Dn(r,e,t){if(t===1n)return 0n;let n=1n;for(r=r%t;e>0n;)BigInt.asUintN(1,e)===1n&&(n=n*r%t),r=r*r%t,e>>=1n;return n}const Qe=20,Je=48,Nn=4,Bn=5,zn=6,xe=new Uint8Array([Je,13+Qe,Je,9,zn,5,43,14,3,2,26,Bn,0,Nn,Qe]);function Un(r,e){const[t,n]=vt(r),s=new Uint8Array(256);let i=0;s[i]=0,i+=1,s[i]=1,i+=1;const a=s.length-xe.length-e.length-1;for(;i<a;)s[i]=255,i+=1;s[i]=0,i+=1,s.set(xe,i),i+=xe.length,s.set(e,i);const o=Dn(Te(s,0,s.length),n,t);return Ce(s,0,s.length,o,!1),s}const g={Auth:1213486401,Close:1163086915,Connect:1314410051,Okay:1497451343,Open:1313165391,Write:1163154007},Le=A({command:d,arg0:d,arg1:d,payloadLength:d,checksum:d,magic:cr},{littleEndian:!0});function At(r){return r.reduce((e,t)=>e+t,0)}class _n extends at{constructor(){const e=new Uint8Array(Le.size);super({transform:async(t,n)=>{await t.tryConsume(async s=>{const i=s;i.payloadLength=i.payload.length,Le.serialize(i,e),await T.ReadableStream.enqueue(n,e),i.payloadLength&&await T.ReadableStream.enqueue(n,i.payload)})}})}}const he={Token:1,Signature:2,PublicKey:3},Wn=async function*(r,e){for await(const t of r.iterateKeys()){const n=await e();if(n.arg0!==he.Token)return;const s=Un(t.buffer,n.payload);yield{command:g.Auth,arg0:he.Signature,arg1:0,payload:s}}},Mn=async function*(r,e){if((await e()).arg0!==he.Token)return;let n;for await(const c of r.iterateKeys()){n=c;break}n||(n=await r.generateKey());const s=kt(),[i]=ht(s),a=n.name?.length?O(n.name):x,o=new Uint8Array(i+(a.length?a.length+1:0)+1);Rn(n.buffer,o),zr(o.subarray(0,s),o),a.length&&(o[i]=32,o.set(a,i+1)),yield{command:g.Auth,arg0:he.PublicKey,arg1:0,payload:o}},qn=[Wn,Mn];class $n{authenticators;#e;#t=new S;#r;constructor(e,t){this.authenticators=e,this.#e=t}#n=()=>this.#t.promise;async*#s(){for(const e of this.authenticators)for await(const t of e(this.#e,this.#n))this.#t=new S,yield t}async process(e){this.#r||(this.#r=this.#s()),this.#t.resolve(e);const t=await this.#r.next();if(t.done)throw new Error("No authenticator can handle the request");return t.value}dispose(){this.#r?.return?.()}}class et{#e;localId;remoteId;localCreated;service;#t;#r;get readable(){return this.#t}#n;writable;#s=!1;#i=new S;get closed(){return this.#i.promise}#c;get socket(){return this.#c}#o;#a=0;constructor(e){this.#e=e.dispatcher,this.localId=e.localId,this.remoteId=e.remoteId,this.localCreated=e.localCreated,this.service=e.service,this.#t=new Z(t=>{this.#r=t}),this.writable=new X({start:t=>{this.#n=t,t.signal.addEventListener("abort",()=>{this.#o?.reject(t.signal.reason)})},write:async t=>{const n=t.length,s=this.#e.options.maxPayloadSize;for(let i=0,a=s;i<n;i=a,a+=s){const o=t.subarray(i,a);await this.#l(o)}}}),this.#c=new jn(this),this.#a=e.availableWriteBytes}async#l(e){const t=e.length;for(;this.#a<t;){const n=new S;this.#o=n,await n.promise}this.#a===1/0?this.#a=-1:this.#a-=t,await this.#e.sendPacket(g.Write,this.localId,this.remoteId,e)}async enqueue(e){await this.#r.enqueue(e)}ack(e){this.#a+=e,this.#o?.resolve()}async close(){if(!this.#s){this.#s=!0,this.#o?.reject(new Error("Socket closed"));try{this.#n.error(new Error("Socket closed"))}catch{}await this.#e.sendPacket(g.Close,this.localId,this.remoteId,x)}}dispose(){this.#r.close(),this.#i.resolve(void 0)}}class jn{#e;get localId(){return this.#e.localId}get remoteId(){return this.#e.remoteId}get localCreated(){return this.#e.localCreated}get service(){return this.#e.service}get readable(){return this.#e.readable}get writable(){return this.#e.writable}get closed(){return this.#e.closed}constructor(e){this.#e=e}close(){return this.#e.close()}}class Vn{#e=new Vt(1);#t=new Map;#r;options;#n=!1;#s=new S;get disconnected(){return this.#s.promise}#i=new Map;#c=new be;constructor(e,t){this.options=t,this.options.initialDelayedAckBytes<0&&(this.options.initialDelayedAckBytes=0),e.readable.pipeTo(new C({write:async n=>{switch(n.command){case g.Close:await this.#o(n);break;case g.Okay:this.#a(n);break;case g.Open:await this.#u(n);break;case g.Write:await this.#h(n);break;default:throw new Error(`Unknown command: ${n.command.toString(16)}`)}}}),{preventCancel:t.preserveConnection??!1,signal:this.#c.signal}).then(()=>{this.#d()},n=>{this.#n||this.#s.reject(n),this.#d()}),this.#r=e.writable.getWriter()}async#o(e){if(e.arg0===0&&this.#e.reject(e.arg1,new Error("Socket open failed")))return;const t=this.#t.get(e.arg1);if(t){await t.close(),t.dispose(),this.#t.delete(e.arg1);return}}#a(e){let t;if(this.options.initialDelayedAckBytes!==0){if(e.payload.length!==4)throw new Error("Invalid OKAY packet. Payload size should be 4");t=pe(e.payload,0)}else{if(e.payload.length!==0)throw new Error("Invalid OKAY packet. Payload size should be 0");t=1/0}if(this.#e.resolve(e.arg1,{remoteId:e.arg0,availableWriteBytes:t}))return;const n=this.#t.get(e.arg1);if(n){n.ack(t);return}this.sendPacket(g.Close,e.arg1,e.arg0,x)}#l(e,t,n){let s;return this.options.initialDelayedAckBytes!==0?(s=new Uint8Array(4),rr(s,0,n)):s=x,this.sendPacket(g.Okay,e,t,s)}async#u(e){const[t]=this.#e.add();this.#e.resolve(t,void 0);const n=e.arg0;let s=e.arg1,i=se(e.payload);if(i.endsWith("\0")&&(i=i.substring(0,i.length-1)),this.options.initialDelayedAckBytes===0){if(s!==0)throw new Error("Invalid OPEN packet. arg1 should be 0");s=1/0}else if(s===0)throw new Error("Invalid OPEN packet. arg1 should be greater than 0");const a=this.#i.get(i);if(!a){await this.sendPacket(g.Close,0,n,x);return}const o=new et({dispatcher:this,localId:t,remoteId:n,localCreated:!1,service:i,availableWriteBytes:s});try{await a(o.socket),this.#t.set(t,o),await this.#l(t,n,this.options.initialDelayedAckBytes)}catch{await this.sendPacket(g.Close,0,n,x)}}async#h(e){const t=this.#t.get(e.arg1);if(!t)throw new Error(`Unknown local socket id: ${e.arg1}`);let n=!1;const s=[(async()=>{await t.enqueue(e.payload),await this.#l(e.arg1,e.arg0,e.payload.length),n=!0})()];this.options.readTimeLimit&&s.push((async()=>{if(await Ot(this.options.readTimeLimit),!n)throw new Error(`readable of \`${t.service}\` has stalled for ${this.options.readTimeLimit} milliseconds`)})()),await Promise.race(s)}async createSocket(e){this.options.appendNullToServiceString&&(e+="\0");const[t,n]=this.#e.add();await this.sendPacket(g.Open,t,this.options.initialDelayedAckBytes,e);const{remoteId:s,availableWriteBytes:i}=await n,a=new et({dispatcher:this,localId:t,remoteId:s,localCreated:!0,service:e,availableWriteBytes:i});return this.#t.set(t,a),a.socket}addReverseTunnel(e,t){this.#i.set(e,t)}removeReverseTunnel(e){this.#i.delete(e)}clearReverseTunnels(){this.#i.clear()}async sendPacket(e,t,n,s){if(typeof s=="string"&&(s=O(s)),s.length>this.options.maxPayloadSize)throw new TypeError("payload too large");await T.WritableStream.write(this.#r,{command:e,arg0:t,arg1:n,payload:s,checksum:this.options.calculateChecksum?At(s):0,magic:e^4294967295})}async close(){await Promise.all(Array.from(this.#t.values(),e=>e.close())),this.#n=!0,this.#c.abort(),this.options.preserveConnection?this.#r.releaseLock():await this.#r.close()}#d(){for(const e of this.#t.values())e.dispose();this.#s.resolve()}}const On=16777217,tt=[b.ShellV2,b.Cmd,b.StatV2,b.ListV2,b.FixedPushMkdir,"apex",b.Abb,"fixed_push_symlink_timestamp",b.AbbExec,"remount_shell","track_app",b.SendReceiveV2,"sendrecv_v2_brotli","sendrecv_v2_lz4","sendrecv_v2_zstd","sendrecv_v2_dry_run_send",b.DelayedAck],Kn=32*1024*1024;class Me{static async authenticate({serial:e,connection:t,credentialStore:n,authenticators:s=qn,features:i=tt,initialDelayedAckBytes:a=Kn,...o}){let c=16777217,l=1024*1024;const u=new S,p=new $n(s,n),E=new be,z=t.readable.pipeTo(new C({async write(f){switch(f.command){case g.Connect:c=Math.min(c,f.arg0),l=Math.min(l,f.arg1),u.resolve(se(f.payload));break;case g.Auth:{const _=await p.process(f);await U(_);break}}}}),{preventCancel:!0,signal:E.signal}).then(()=>{u.reject(new Error("Connection closed unexpectedly"))},f=>{u.reject(f)}),D=t.writable.getWriter();async function U(f){f.checksum=At(f.payload),f.magic=f.command^4294967295,await T.WritableStream.write(D,f)}const q=i.slice();if(a<=0){const f=i.indexOf(b.DelayedAck);f!==-1&&q.splice(f,1)}let v;try{await U({command:g.Connect,arg0:c,arg1:l,payload:O(`host::features=${q.join(",")}`)}),v=await u.promise}finally{E.abort(),D.releaseLock(),await z}return new Me({serial:e,connection:t,version:c,maxPayloadSize:l,banner:v,features:q,initialDelayedAckBytes:a,...o})}#e;get connection(){return this.#e}#t;#r;get serial(){return this.#r}#n;get protocolVersion(){return this.#n}get maxPayloadSize(){return this.#t.options.maxPayloadSize}#s;get banner(){return this.#s}get disconnected(){return this.#t.disconnected}#i;get clientFeatures(){return this.#i}constructor({serial:e,connection:t,version:n,banner:s,features:i=tt,initialDelayedAckBytes:a,...o}){if(this.#r=e,this.#e=t,this.#s=We.parse(s),this.#i=i,i.includes(b.DelayedAck)){if(a<=0)throw new TypeError("`initialDelayedAckBytes` must be greater than 0 when DelayedAck feature is enabled.");this.#s.features.includes(b.DelayedAck)||(a=0)}else a=0;let c,l;n>=On?(c=!1,l=!1):(c=!0,l=!0),this.#t=new Vn(t,{calculateChecksum:c,appendNullToServiceString:l,initialDelayedAckBytes:a,...o}),this.#n=n}connect(e){return this.#t.createSocket(e)}addReverseTunnel(e,t){return t||(t=`localabstract:reverse_${Math.random().toString().substring(2)}`),this.#t.addReverseTunnel(t,e),t}removeReverseTunnel(e){this.#t.removeReverseTunnel(e)}clearReverseTunnels(){this.#t.clearReverseTunnels()}close(){return this.#t.close()}}function Fn(r,e){e<0||e>=r.length||(r[e]=r[r.length-1],r.length-=1)}class Gn extends Error{constructor(e){super("The device is already in used by another program",{cause:e})}}function qe(r,e){return typeof r=="object"&&r!==null&&"name"in r&&r.name===e}function Hn(r){return r.classCode!==void 0&&r.subclassCode!==void 0&&r.protocolCode!==void 0}function Yn(r,e){return r.interfaceClass===e.classCode&&r.interfaceSubclass===e.subclassCode&&r.interfaceProtocol===e.protocolCode}function Zn(r,e){for(const t of r.configurations)for(const n of t.interfaces)for(const s of n.alternates)if(Yn(s,e))return{configuration:t,interface_:n,alternate:s}}function rt(r){return r.toString(16).padStart(4,"0")}function It(r){return r.serialNumber?r.serialNumber:rt(r.vendorId)+"x"+rt(r.productId)}function Xn(r){if(r.length===0)throw new TypeError("No endpoints given");let e,t;for(const n of r)switch(n.direction){case"in":if(e=n,t)return{inEndpoint:e,outEndpoint:t};break;case"out":if(t=n,e)return{inEndpoint:e,outEndpoint:t};break}throw e?t?new Error("unreachable"):new TypeError("No output endpoint found."):new TypeError("No input endpoint found.")}function Qn(r,e){return e.vendorId!==void 0&&r.vendorId!==e.vendorId||e.productId!==void 0&&r.productId!==e.productId||e.serialNumber!==void 0&&It(r)!==e.serialNumber?!1:Hn(e)?Zn(r,e)||!1:!0}function fe(r,e,t){if(t&&t.length>0&&fe(r,t))return!1;for(const n of e){const s=Qn(r,n);if(s)return s}return!1}const oe={classCode:255,subclassCode:66,protocolCode:1};function Pe(r){return!r||r.length===0?[oe]:r.map(e=>({...e,classCode:e.classCode??oe.classCode,subclassCode:e.subclassCode??oe.subclassCode,protocolCode:e.protocolCode??oe.protocolCode}))}class Jn{#e;get device(){return this.#e}#t;get inEndpoint(){return this.#t}#r;get outEndpoint(){return this.#r}#n;get readable(){return this.#n}#s;get writable(){return this.#s}constructor(e,t,n,s){this.#e=e,this.#t=t,this.#r=n;let i=!1;const a=new vr({close:async()=>{try{i=!0,await e.raw.close()}catch{}},dispose:()=>{i=!0,s.removeEventListener("disconnect",o)}});function o(l){l.device===e.raw&&a.dispose().catch(ft)}s.addEventListener("disconnect",o),this.#n=a.wrapReadable(new B({pull:async l=>{const u=await this.#i();u?l.enqueue(u):l.close()}},{highWaterMark:0}));const c=n.packetSize-1;this.#s=Ar(a.createWritable(new X({write:async l=>{try{await e.raw.transferOut(n.endpointNumber,l),c&&(l.length&c)===0&&await e.raw.transferOut(n.endpointNumber,x)}catch(u){if(i)return;throw u}}})),new _n)}async#i(){try{for(;;){const e=await this.#e.raw.transferIn(this.#t.endpointNumber,this.#t.packetSize);if(e.data.byteLength!==24)continue;const t=new Uint8Array(e.data.buffer),n=new Yt(t),s=Le.deserialize(n);if(s.magic===(s.command^4294967295)){if(s.payloadLength!==0){const i=await this.#e.raw.transferIn(this.#t.endpointNumber,s.payloadLength);s.payload=new Uint8Array(i.data.buffer)}else s.payload=x;return s}}}catch(e){if(qe(e,"NetworkError")&&(await new Promise(t=>{setTimeout(()=>{t()},100)}),closed))return;throw e}}}class re{static DeviceBusyError=Gn;#e;#t;#r;get raw(){return this.#r}#n;get serial(){return this.#n}get name(){return this.#r.productName}constructor(e,t,n){this.#r=e,this.#n=It(e),this.#e=t,this.#t=n}async#s(){this.#r.opened||await this.#r.open();const{configuration:e,interface_:t,alternate:n}=this.#e;if(this.#r.configuration?.configurationValue!==e.configurationValue&&await this.#r.selectConfiguration(e.configurationValue),!t.claimed)try{await this.#r.claimInterface(t.interfaceNumber)}catch(s){throw qe(s,"NetworkError")?new re.DeviceBusyError(s):s}return t.alternate.alternateSetting!==n.alternateSetting&&await this.#r.selectAlternateInterface(t.interfaceNumber,n.alternateSetting),Xn(n.endpoints)}async connect(){const{inEndpoint:e,outEndpoint:t}=await this.#s();return new Jn(this,e,t,this.#t)}}class $e{static async create(e,t={}){const n=await e.getDevices();return new $e(e,n,t)}#e;#t;#r;#n=new Ae;onDeviceAdd=this.#n.event;#s=new Ae;onDeviceRemove=this.#s.event;#i=new Tr;onListChange=this.#i.event;current=[];constructor(e,t,n={}){this.#e=Pe(n.filters),this.#t=n.exclusionFilters,this.#r=e,this.current=t.map(s=>this.#c(s)).filter(s=>!!s),this.#i.fire(this.current),this.#r.addEventListener("connect",this.#o),this.#r.addEventListener("disconnect",this.#a)}#c(e){const t=fe(e,this.#e,this.#t);if(t)return new re(e,t,this.#r)}#o=e=>{const t=this.#c(e.device);if(!t)return;const n=this.current.slice();n.push(t),this.current=n,this.#n.fire([t]),this.#i.fire(this.current)};#a=e=>{const t=this.current.findIndex(n=>n.raw===e.device);if(t!==-1){const n=this.current[t],s=this.current.slice();Fn(s,t),this.current=s,this.#s.fire([n]),this.#i.fire(this.current)}};stop(){this.#r.removeEventListener("connect",this.#o),this.#r.removeEventListener("disconnect",this.#a),this.#n.dispose(),this.#s.dispose(),this.#i.dispose()}}class je{static BROWSER=typeof globalThis.navigator<"u"&&globalThis.navigator.usb?new je(globalThis.navigator.usb):void 0;#e;constructor(e){this.#e=e}async requestDevice(e={}){const t=Pe(e.filters);try{const n=await this.#e.requestDevice({filters:t,exclusionFilters:e.exclusionFilters}),s=fe(n,t,e.exclusionFilters);return s?new re(n,s,this.#e):void 0}catch(n){if(qe(n,"NotFoundError"))return;throw n}}async getDevices(e={}){const t=Pe(e.filters),n=await this.#e.getDevices(),s=[];for(const i of n){const a=fe(i,t,e.exclusionFilters);a&&s.push(new re(i,a,this.#e))}return s}trackDevices(e={}){return $e.create(this.#e,e)}}function Tt(){return new Promise((r,e)=>{const t=indexedDB.open("Tango",1);t.onerror=()=>{e(t.error)},t.onupgradeneeded=()=>{t.result.createObjectStore("Authentication",{autoIncrement:!0})},t.onsuccess=()=>{const n=t.result;r(n)}})}async function es(r){const e=await Tt();return new Promise((t,n)=>{const s=e.transaction("Authentication","readwrite"),a=s.objectStore("Authentication").add(r);a.onerror=()=>{n(a.error)},a.onsuccess=()=>{t()},s.onerror=()=>{n(s.error)},s.oncomplete=()=>{e.close()}})}async function ts(){const r=await Tt();return new Promise((e,t)=>{const n=r.transaction("Authentication","readonly"),i=n.objectStore("Authentication").getAll();i.onerror=()=>{t(i.error)},i.onsuccess=()=>{e(i.result)},n.onerror=()=>{t(n.error)},n.oncomplete=()=>{r.close()}})}class rs{#e;constructor(e="Tango"){this.#e=e}async generateKey(){const{privateKey:e}=await crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-1"},!0,["sign","verify"]),t=new Uint8Array(await crypto.subtle.exportKey("pkcs8",e));return await es(t),{buffer:t,name:`${this.#e}@${globalThis.location.hostname}`}}async*iterateKeys(){for(const e of await ts())yield{buffer:e,name:`${this.#e}@${globalThis.location.hostname}`}}}const ns=document.getElementById("pick"),Ct=document.getElementById("push"),nt=document.getElementById("bar"),ss=document.getElementById("cmd"),Lt=document.getElementById("runCmd"),V=document.getElementById("stopCmd");let k=null,W=[];const F=document.getElementById("log"),Pt=document.getElementById("connect"),Rt=document.getElementById("disconnect"),Dt=document.getElementById("gammaray"),Nt=document.getElementById("usbdialog"),Bt=document.getElementById("reboot"),zt=document.getElementById("startLogs"),Y=document.getElementById("stopLogs"),st=je.BROWSER;let w=null,ee=null;const is=new TextDecoder;let P=null,G=[];const Ut=document.getElementById("fsRefresh"),_t=document.getElementById("fsUp"),Wt=document.getElementById("fsGo"),Q=document.getElementById("fsPath"),Re=document.getElementById("fsList");function h(r){F.textContent+=r+`
`,F.textContent.length>2e6&&(F.textContent=F.textContent.slice(-1e6)),F.scrollTop=F.scrollHeight}function Ve(r){Pt.disabled=r,Rt.disabled=!r,Dt.disabled=!r,Nt.disabled=!r,Bt.disabled=!r,zt.disabled=!r,Ct.disabled=!r,Y.disabled=!r||k===null,Lt.disabled=!r,V.disabled=!r||k===null,Ut.disabled=!r,_t.disabled=!r,Wt.disabled=!r,Q.disabled=!r}async function as(){if(!st){h("❌ WebUSB not available. Use Chrome/Edge and https:// or http://localhost");return}try{h("🔌 Requesting device…");const r=await st.requestDevice();if(!r){h("Canceled.");return}h("🔗 Claiming ADB interface…");const e=await r.connect();h("🔐 Authenticating (check your phone for the RSA dialog) …"),ee=await Me.authenticate({serial:r.serial,connection:e,credentialStore:new rs("WebADB Demo Key")}),w=new kn(ee),h("✅ Connected!"),Ve(!0),await ie("/")}catch(r){const e=String(r?.message||r);/busy|in use/i.test(e)?h("⚠️ The phone’s ADB interface is already in use by another program. Close Android Studio/scrcpy/etc. and run `adb kill-server`, then try again."):h("❌ "+e),await Mt()}}async function Mt(){if(await qt(),ee)try{await ee.close()}catch{}ee=null,w=null,Ve(!1),h("🔌 Disconnected."),Re.innerHTML="",Q.value="/"}async function os(){if(!w)return;h("▶️▶️starting gammaray");const e=(await w.subprocess.noneProtocol.spawn("source /env.sh && /usr/bin/gammaray -p $(pidof nickel) --inject-only")).output.getReader(),{value:t}=await e.read();e.releaseLock();const n=is.decode(t||new Uint8Array).trim();h("📱 "+n)}async function cs(){w&&(h("▶️▶️sow usb dialog"),await w.subprocess.noneProtocol.spawn("echo usb plug add > /tmp/nickel-hardware-status"))}async function ls(){w&&await w.subprocess.noneProtocol.spawn("reboot")}async function ds(){if(!(!w||P))try{if(w.subprocess.shellProtocol){h("🟢 logread via shellProtocol"),P=await w.subprocess.shellProtocol.spawn(["logread","-f"]);const r=new TextDecoder,e=P.stdout.getReader(),t=P.stderr.getReader();G=[e,t],(async()=>{try{for(;;){const[{value:n,done:s},{value:i,done:a}]=await Promise.all([e.read(),t.read()]);if(s&&a)break;n?.length&&h(r.decode(n,{stream:!0})),i?.length&&h(r.decode(i,{stream:!0}))}}catch{}finally{try{e.releaseLock()}catch{}try{t.releaseLock()}catch{}G=[],P=null,Y.disabled=!0,h("🛑 logread ended.")}})()}else{h("🟢 logread via noneProtocol (legacy)"),P=await w.subprocess.noneProtocol.spawn(["logread","-f"]);const r=P.output.getReader();G=[r];const e=new TextDecoder;(async()=>{try{for(;;){const{value:t,done:n}=await r.read();if(n)break;t?.length&&h(e.decode(t,{stream:!0}))}}catch{}finally{try{r.releaseLock()}catch{}G=[],P=null,Y.disabled=!0,h("🛑 logread ended.")}})()}Y.disabled=!1}catch(r){console.error(r)}}async function qt(){if(P){h("🟡 Stopping logread…");try{await P.kill?.()}catch{}for(const r of G)try{await r.cancel()}catch{}G=[],P=null,Y.disabled=!0}}Ct.addEventListener("click",async()=>{if(!w)return;const r=ns.files?.[0];if(!r){h("Pick a file first");return}const e=await w.sync();try{const t=r.size;let n=0;const s=r.stream().pipeThrough(new TransformStream({transform(a,o){n+=a.byteLength,nt.value=t?n/t:0,o.enqueue(a)}})),i=`/mnt/onboard/.kobo/${r.name}`;h(`⬆️ Pushing to ${i} …`),await e.write({filename:i,file:s}),h("✅ Push complete")}catch(t){h("❌ Push failed: "+(t?.message??t))}finally{await e.dispose(),nt.value=0}});async function us(){if(!w||k)return;const r=ss.value.trim();if(!r){h("Type a command first");return}h("▶️ "+r),V.disabled=!1;try{const e=["sh","-c",'"'+r+'"'];if(w.subprocess.shellProtocol){k=await w.subprocess.shellProtocol.spawn(e);const t=k.stdout.getReader(),n=k.stderr.getReader();W=[t,n];const s=new TextDecoder;(async()=>{try{for(;;){const[i,a]=await Promise.all([t.read(),n.read()]);if(i.done&&a.done)break;i.value?.length&&h(s.decode(i.value,{stream:!0})),a.value?.length&&h(s.decode(a.value,{stream:!0}))}}catch{}finally{try{t.releaseLock()}catch{}try{n.releaseLock()}catch{}W=[],k=null,V.disabled=!0,h("⏹️ command ended")}})()}else{k=await w.subprocess.noneProtocol.spawn(e);const t=k.output.getReader();W=[t];const n=new TextDecoder;(async()=>{try{for(;;){const{value:s,done:i}=await t.read();if(i)break;s?.length&&h(n.decode(s,{stream:!0}))}}catch{}finally{try{t.releaseLock()}catch{}W=[],k=null,V.disabled=!0,h("⏹️ command ended")}})()}}catch(e){h("❌ could not start command: "+e.message),console.error(e),k=null;for(const t of W)try{await t.cancel()}catch{}W=[],V.disabled=!0}}async function hs(){if(k){h("🛑 Stopping command…");try{await k.kill?.()}catch{}for(const r of W)try{await r.cancel()}catch{}W=[],k=null,V.disabled=!0}}function fs(r,e){return r?(r.endsWith("/")&&(r=r.slice(0,-1)),(r||"/")+"/"+(e||"")):e||"/"}function ws(r){if(r==="/")return"/";const e=r.replace(/\/+$/,"").split("/");e.pop();const t=e.join("/");return t.length?t:"/"}function $t(r){return r.replace(/\/+$/,"").split("/").pop()||"/"}function $(r){return(r&61440)===16384}function jt(r){if(r<1024)return`${r} B`;const e=["KB","MB","GB","TB"];let t=-1;do r/=1024,t++;while(r>=1024&&t<e.length-1);return`${r.toFixed(r>=10?0:1)} ${e[t]}`}function ps(r){try{return new Date(r*1e3).toLocaleString()}catch{return String(r)}}async function ys(r){if(!w)return[];const e=await w.sync(),t=[];try{for await(const n of e.opendir(r))t.push({name:n.name,mode:Number(n.mode),size:Number(n.size),mtime:Number(n.mtime),path:fs(r,n.name)})}catch(n){h(`❌ list failed for ${r}: ${n?.message||n}`)}finally{await e.dispose()}return t.sort((n,s)=>{const i=$(n.mode),a=$(s.mode);return i!==a?i?-1:1:n.name.localeCompare(s.name)}),t}function bs(r,e){Re.innerHTML="",Q.value=r;for(const t of e){const n=document.createElement("li");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="space-between",n.style.padding="6px 8px",n.style.borderBottom="1px dashed #ccc",n.style.cursor="default";const s=document.createElement("div"),i=document.createElement("div"),a=$(t.mode)?"📁":"📄",o=document.createElement("span");o.textContent=`${a} ${t.name}`,o.style.userSelect="text",o.style.fontWeight=$(t.mode)?"600":"400",$(t.mode)?(o.style.cursor="pointer",o.ondblclick=async()=>{await ie(t.path)}):o.onclick=()=>{l.hidden=!l.hidden},s.appendChild(o);const c=document.createElement("span");c.textContent=$(t.mode)?"":`${jt(t.size)} • ${ps(t.mtime)}`,c.style.opacity="0.7",c.style.fontSize="12px",c.style.marginLeft="8px",s.appendChild(c);const l=document.createElement("div");if(l.hidden=!0,!$(t.mode)){const u=document.createElement("button");u.textContent="View (head)",u.onclick=()=>ms(t.path);const p=document.createElement("button");p.textContent="Download",p.onclick=()=>gs(t.path,t.name),l.appendChild(u),l.appendChild(p)}i.appendChild(l),n.appendChild(s),n.appendChild(i),Re.appendChild(n)}}async function ie(r){const e=await ys(r);bs(r,e)}async function ms(r,e=4096){if(!w)return;const t=await w.sync();try{h(`👀 Reading head of ${r} …`);const s=(await t.read(r)).getReader();let i=0;const a=[];for(;i<e;){const{value:u,done:p}=await s.read();if(p||!u)break;const E=Math.max(0,e-i);if(a.push(u.subarray(0,E)),i+=Math.min(u.byteLength,E),i>=e)break}try{s.releaseLock()}catch{}const o=new Uint8Array(a.reduce((u,p)=>u+p.byteLength,0));let c=0;for(const u of a)o.set(u,c),c+=u.byteLength;const l=new TextDecoder().decode(o);h(`----- BEGIN ${r} (first ${i} bytes) -----
`+l+`
----- END ${$t(r)} -----`)}catch(n){h("❌ preview failed: "+(n?.message??n))}finally{await t.dispose()}}async function gs(r,e){if(!w)return;const t=await w.sync();try{h(`⬇️ Downloading ${r} …`);const s=(await t.read(r)).getReader(),i=[];let a=0;for(;;){const{value:u,done:p}=await s.read();if(p)break;u?.length&&(i.push(u),a+=u.byteLength)}try{s.releaseLock()}catch{}const o=new Blob(i,{type:"application/octet-stream"}),c=URL.createObjectURL(o),l=document.createElement("a");l.href=c,l.download=e||$t(r),l.click(),URL.revokeObjectURL(c),h(`✅ Downloaded ${e} (${jt(a)})`)}catch(n){h("❌ download failed: "+(n?.message??n))}finally{await t.dispose()}}Pt.addEventListener("click",()=>as());Rt.addEventListener("click",()=>Mt());Dt.addEventListener("click",()=>os());Nt.addEventListener("click",()=>cs());Bt.addEventListener("click",()=>ls());zt.addEventListener("click",()=>ds());Y.addEventListener("click",()=>qt());Lt.addEventListener("click",()=>us());V.addEventListener("click",()=>hs());Ut.addEventListener("click",()=>ie(Q.value||"/"));_t.addEventListener("click",()=>ie(ws(Q.value||"/")));Wt.addEventListener("click",()=>ie(Q.value||"/"));Ve(!1);
